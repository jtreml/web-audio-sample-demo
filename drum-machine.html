<link rel="import" href="note-button.html" />
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-icon/iron-icon.html" />
<link rel="import" href="../iron-icons/iron-icons.html" />
<link rel="import" href="../paper-tooltip/paper-tooltip.html" />
<link rel="import" href="../web-audio-sample/web-audio-sample.html" />
<dom-module id="drum-machine">
    <style>
      :host {
        display: block;
      }
    </style>

    <template>
        <style>
            :host {
                display: block;
                @apply(--layout-vertical);
            }

            paper-material {
                width: 110px;
                height: 36px;
                position: relative;
                margin: 24px 6px 0 6px;
                text-align: left;
                line-height: 36px;
                padding: 0 6px 0 6px;
                background-color: #eeeeee;
            }
        </style>

        <template is="dom-repeat" items="[[tracks]]">
            <div class="track layout horizontal flex" id$="[[item.id]]" style="position: relative;">
                <web-audio-sample src$="[[resolveUrl(item.sample)]]"></web-audio-sample>

                <paper-material elevation="1">[[item.id]]</paper-material>
                <template is="dom-repeat" items="[[item.notes]]">
                    <note-button expert-mode="[[expertMode]]" data-index$="[[index]]" note$="[[item]]" class="flex" style="height: 36px; position: relative; margin: 24px 6px 0 6px;"></note-button>
                </template>

                <div id="custom-[[index]]" hidden$="[[!custom]]"></div>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'drum-machine',

            properties: {
                expertMode: Boolean,
                tracks: {
                    type: Array,
                    notify: true,
                    value: [
                        {
                            "id": "kick",
                            "sample": "sounds/BT7AADA.WAV",
                            "notes": [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0]
                        },
                        {
                            "id": "snare",
                            "sample": "sounds/ST7T0SA.WAV",
                            "notes": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1]
                        },
                        {
                            "id": "clap",
                            "sample": "sounds/HANDCLP1.WAV",
                            "notes": [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0]
                        },
                        {
                            "id": "closed-hihat",
                            "sample": "sounds/HHCD0.WAV",
                            "notes": [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0]
                        },
                        {
                            "id": "open-hihat",
                            "sample": "sounds/HHOD4.WAV",
                            "notes": [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0]
                        },
                        {
                            "id": "crash",
                            "sample": "sounds/CSHD6.WAV",
                            "notes": [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        }
                    ]
                },
                play: {
                    type: Boolean,
                    value: false
                },
                custom: {
                    type: Boolean,
                    value: false
                },
                renderer: {
                    type: Object,
                    value: function() { }
                }
            },

            listeners: {
                'toggle-note': '_handleToggleNote'
            },

            observers: [
                '_rendererChanged(renderer)'
            ],

            clearTracks: function() {
                this.tracks.forEach(function(track, index) {
                    this.set('tracks.' + this.tracks.indexOf(track) + '.notes', [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
                }.bind(this));
            },

            _handleToggleNote: function(e) {
                var noteValue = e.detail.value;
                var trackId = e.target.parentElement.id;
                var noteIndex = e.target.getAttribute('data-index');

                var track = this.tracks.filter(function(track) {
                    return track.id === trackId;
                });
                if (track.length === 1) {
                    // Works, but ugly
                    // Copy the array to make Polymer notice the change.
                    // Two levels of array changes not supported?
                    var notes = JSON.parse(JSON.stringify(track[0].notes));
                    notes[noteIndex] = noteValue;
                    this.set('tracks.' + this.tracks.indexOf(track[0]) + '.notes', notes);
                }
            },

            ready: function() {
                var playHead = -1;
                var tracks = this.tracks;
                window.setInterval(function() {
                    if(!this.play) {
                        return;
                    }
                    tracks.forEach(function(track, i) {
                        var activeNote = Polymer.dom(this.root).querySelector('#' + track.id + ' note-button.active');
                        if (activeNote) {
                            activeNote.classList.remove('active');
                        }
                    }.bind(this));

                    playHead++;
                    if (playHead == 16) {
                        playHead = 0;
                    }
                    var played = [];
                    tracks.forEach(function(track, i) {
                        var notes = track.notes;
                        var note = notes[playHead];

                        var noteButton = Polymer.dom(this.root).querySelector('#' + track.id + ' note-button:nth-of-type(' + (playHead + 1) + ')');
                        if (noteButton) {
                            noteButton.classList.add('active');
                        }
                        if (note !== 0) {
                            var sample = Polymer.dom(this.root).querySelector('#' + track.id + ' web-audio-sample');
                            sample.playbackRate = note;
                            sample.play();
                            played.push({
                                index: i,
                                rate: note
                            })
                        }
                    }.bind(this));
                    if(played.length > 0) {
                        this.fire('play', played);
                    }
                }.bind(this), 140);
            },

            _rendererChanged: function(renderer) {
                if(!renderer) {
                    return;
                }

                var _this = this;
                this.async(function() {
                    this.tracks.forEach((track, i) => {
                        var el = Polymer.dom(_this.root).querySelector('#custom-' + i);
                        this.renderer(el, i);
                    })
                })
            }
        });
    </script>
</dom-module>
